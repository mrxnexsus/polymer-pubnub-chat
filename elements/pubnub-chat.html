<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element
    constructor="PubNubChat"
     attributes="publish-key subscribe-key chat-room auto-focus"
           name="pubnub-chat">

    <template>
        <!-- PubNub Chat -->
        <div><input id="input" placeholder="Chat here" /></div>
        <div id="box"></div>
    </template>

    <style>
        #input {
            padding: 10px 5px 5px 5px;
            margin: 10px;
            border: 0;
            border-bottom: 1px solid #333;
            outline: none;
            font-size: 20px;
            font-family: "Helvetica Neue";
        }

        #box {
            margin: 10px;
            font-size: 20px;
            font-family: "Helvetica Neue";
            font-weight: 100;
        }
    </style>

    <script src="http://cdn.pubnub.com/pubnub.min.js"></script>
    <script>
        Polymer( 'pubnub-chat', {
            ready : function() {
                var   self = this
                ,   pubnub = self.pubnub = PUBNUB({
                      publish_key : this['publish-key'],
                    subscribe_key : this['subscribe-key']
                });

                setup_chat(self);
            }
        } );

        // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
        // Setup Chat
        // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
        function setup_chat(self) {
            var     box = self.$.box
            ,     input = self.$.input
            ,    pubnub = self.pubnub
            , autofocus = self['auto-focus']
            ,   channel = self['chat-room'];

            // Auto Focus Input
            if (autofocus) input.focus();

            // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
            // Open TCP Socket for Chat Messages
            // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
            pubnub.subscribe({
                channel : channel,
                message : function(text) {
                    box.innerHTML = (''+text).replace( /[<>]/g, '' ) +
                    '<br>' + box.innerHTML
                },
                connect : function() {
                    send('Joined Chat!');
                }
            });

            // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
            // Send Event
            // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
            function send(data) {
                pubnub.publish({
                    channel : channel,
                    message : data
                });
            }

            // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
            // Bind 'Enter' Key
            // -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
            pubnub.bind( 'keyup', input, function(e) {
                if ((e.keyCode || e.charCode) !== 13) return;
                send(input.value);
                input.value = '';
            } );
        }
    </script>

</polymer-element>
